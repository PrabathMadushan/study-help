rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // DENY ALL BY DEFAULT
    // Any path not explicitly allowed is denied
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
    
    // ============================================
    // USER DATA RULES
    // Path: /users/{userId}
    // ============================================
    match /users/{userId} {
      // Users can only read their own user document
      allow read: if isOwner(userId);
      
      // Users can create their own user document (on first sign-up)
      allow create: if isOwner(userId) 
        && isValidUserDoc()
        && request.resource.data.size() <= 10;
      
      // Users can update their own user document
      allow update: if isOwner(userId) 
        && isValidUserDoc()
        && request.resource.data.size() <= 10;
      
      // Prevent accidental/malicious deletion of user data
      allow delete: if false;
      
      // ============================================
      // PROGRESS SUBCOLLECTION - PER SUBJECT
      // Path: /users/{userId}/progress/{subjectId}/state
      // Stores study progress per subject: { notes: { [noteId]: { score: number } } }
      // ============================================
      match /progress/{subjectId}/{docId} {
        // Users can read their own progress
        allow read: if isOwner(userId);
        
        // Users can create progress document
        allow create: if isOwner(userId) 
          && isValidProgressDoc()
          && docId == 'state'; // Only allow the 'state' document
        
        // Users can update their progress
        allow update: if isOwner(userId) 
          && isValidProgressDoc()
          && docId == 'state'; // Only allow the 'state' document
        
        // Prevent deletion of progress data
        allow delete: if false;
      }
    }
    
    // ============================================
    // ADMIN COLLECTION
    // Path: /admins/{userId}
    // ============================================
    match /admins/{adminId} {
      // Anyone authenticated can read (to check if they're admin)
      allow read: if request.auth != null;
      
      // Only existing admins can create new admins
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // CATEGORIES (V2 - Unified Tree Structure)
    // Path: /categories/{categoryId}
    // ============================================
    match /categories/{categoryId} {
      allow read: if request.auth != null;
      allow create, update: if isAdmin() && isValidCategoryV2();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // NOTES (V2 - Single categoryId reference)
    // Path: /notes/{noteId}
    // ============================================
    match /notes/{noteId} {
      allow read: if request.auth != null;
      allow create, update: if isAdmin() && isValidNoteV2();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // FLASHCARDS (per leaf category)
    // Path: /flashcards/{flashcardId}
    // ============================================
    match /flashcards/{flashcardId} {
      allow read: if request.auth != null;
      allow create, update: if isAdmin() && isValidFlashcard();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // EXAM QUESTIONS (per leaf category)
    // Path: /exam_questions/{questionId}
    // ============================================
    match /exam_questions/{questionId} {
      allow read: if request.auth != null;
      allow create, update: if isAdmin() && isValidExamQuestion();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if the authenticated user owns this resource
    function isOwner(userId) {
      return request.auth != null 
        && request.auth.uid == userId;
    }
    
    // Stricter version requiring email verification
    // Uncomment and use isOwnerVerified() instead of isOwner() to enforce
    // function isOwnerVerified(userId) {
    //   return request.auth != null 
    //     && request.auth.uid == userId
    //     && request.auth.token.email_verified == true;
    // }
    
    // Validate user document structure
    function isValidUserDoc() {
      let data = request.resource.data;
      // Only allow specific fields
      return data.keys().hasOnly(['createdAt', 'updatedAt', 'email', 'displayName'])
        // Validate field types if present
        && (!('createdAt' in data) || data.createdAt is timestamp)
        && (!('updatedAt' in data) || data.updatedAt is timestamp)
        && (!('email' in data) || (data.email is string && data.email.size() <= 320))
        && (!('displayName' in data) || (data.displayName is string && data.displayName.size() <= 100));
    }
    
    // Validate progress document structure
    // Structure: { notes: { [noteId]: { score: number } } }
    function isValidProgressDoc() {
      let data = request.resource.data;
      
      // Must have only 'notes' field
      return data.keys().hasOnly(['notes'])
        // Notes must be a map
        && data.notes is map
        // Limit total size to prevent abuse (max 1000 notes)
        && data.notes.size() <= 1000;
    }
    
    // Check if user is an admin
    function isAdmin() {
      return request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ============================================
    // V2 UNIFIED CATEGORY SYSTEM VALIDATION
    // ============================================
    
    // Validate V2 category document (unified tree structure)
    function isValidCategoryV2() {
      let data = request.resource.data;
      return data.keys().hasOnly(['parentId', 'name', 'description', 'icon', 'color', 'isLeaf', 'order', 'depth', 'path', 'createdAt', 'updatedAt'])
        && 'name' in data && data.name is string && data.name.size() > 0 && data.name.size() <= 200
        && 'isLeaf' in data && data.isLeaf is bool
        && 'order' in data && data.order is number
        && 'depth' in data && data.depth is number && data.depth >= 0 && data.depth <= 50
        && 'path' in data && data.path is list && data.path.size() <= 50
        && (!('description' in data) || (data.description is string && data.description.size() <= 1000))
        && (!('icon' in data) || (data.icon is string && data.icon.size() <= 100))
        && (!('color' in data) || (data.color is string && data.color.size() <= 50))
        && (!('parentId' in data) || data.parentId is string || data.parentId == null)
        && ((data.parentId == null && data.depth == 0 && data.path.size() == 0) || (data.parentId != null && data.depth == data.path.size()));
    }
    
    // Validate V2 note document (single categoryId reference)
    function isValidNoteV2() {
      let data = request.resource.data;
      return data.keys().hasOnly(['categoryId', 'path', 'title', 'content', 'interviewAnswer', 'order', 'createdAt', 'updatedAt'])
        && data.categoryId is string && data.categoryId.size() > 0 && data.categoryId.size() <= 100
        && data.path is list && data.path.size() >= 1 && data.path.size() <= 50
        && data.title is string && data.title.size() > 0 && data.title.size() <= 500
        && data.content is string && data.content.size() <= 100000
        && data.order is number
        && (!('interviewAnswer' in data) || (data.interviewAnswer is string && data.interviewAnswer.size() <= 5000))
        && data.path[data.path.size() - 1] == data.categoryId;
    }
    
    // Validate flashcard document
    function isValidFlashcard() {
      let data = request.resource.data;
      return data.keys().hasOnly(['categoryId', 'question', 'answer', 'order', 'createdAt', 'updatedAt'])
        && data.categoryId is string && data.categoryId.size() > 0 && data.categoryId.size() <= 100
        && data.question is string && data.question.size() > 0 && data.question.size() <= 2000
        && data.answer is string && data.answer.size() > 0 && data.answer.size() <= 10000
        && data.order is number
        && data.createdAt is timestamp
        && data.updatedAt is timestamp;
    }
    
    // Validate exam question document
    function isValidExamQuestion() {
      let data = request.resource.data;
      return data.keys().hasOnly(['categoryId', 'question', 'type', 'options', 'correctAnswer', 'order', 'createdAt', 'updatedAt'])
        && data.categoryId is string && data.categoryId.size() > 0 && data.categoryId.size() <= 100
        && data.question is string && data.question.size() > 0 && data.question.size() <= 2000
        && data.type is string && (data.type == 'mcq' || data.type == 'short')
        && data.correctAnswer is string && data.correctAnswer.size() <= 2000
        && data.order is number
        && data.createdAt is timestamp
        && data.updatedAt is timestamp
        && (!('options' in data) || (data.options is list && data.options.size() <= 20));
    }
  }
}