rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // DENY ALL BY DEFAULT
    // Any path not explicitly allowed is denied
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
    
    // ============================================
    // USER DATA RULES
    // Path: /users/{userId}
    // ============================================
    match /users/{userId} {
      // Users can only read their own user document
      allow read: if isOwner(userId);
      
      // Users can create their own user document (on first sign-up)
      allow create: if isOwner(userId) 
        && isValidUserDoc()
        && request.resource.data.size() <= 10;
      
      // Users can update their own user document
      allow update: if isOwner(userId) 
        && isValidUserDoc()
        && request.resource.data.size() <= 10;
      
      // Prevent accidental/malicious deletion of user data
      allow delete: if false;
      
      // ============================================
      // PROGRESS SUBCOLLECTION
      // Path: /users/{userId}/progress/{docId}
      // Stores study progress with structure: { notes: { [noteId]: { score: number } } }
      // ============================================
      match /progress/{docId} {
        // Users can read their own progress
        allow read: if isOwner(userId);
        
        // Users can create progress document
        allow create: if isOwner(userId) 
          && isValidProgressDoc()
          && docId == 'state'; // Only allow the 'state' document
        
        // Users can update their progress
        allow update: if isOwner(userId) 
          && isValidProgressDoc()
          && docId == 'state'; // Only allow the 'state' document
        
        // Prevent deletion of progress data
        allow delete: if false;
      }
    }
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if the authenticated user owns this resource
    function isOwner(userId) {
      return request.auth != null 
        && request.auth.uid == userId;
    }
    
    // Stricter version requiring email verification
    // Uncomment and use isOwnerVerified() instead of isOwner() to enforce
    // function isOwnerVerified(userId) {
    //   return request.auth != null 
    //     && request.auth.uid == userId
    //     && request.auth.token.email_verified == true;
    // }
    
    // Validate user document structure
    function isValidUserDoc() {
      let data = request.resource.data;
      // Only allow specific fields
      return data.keys().hasOnly(['createdAt', 'updatedAt', 'email', 'displayName'])
        // Validate field types if present
        && (!('createdAt' in data) || data.createdAt is timestamp)
        && (!('updatedAt' in data) || data.updatedAt is timestamp)
        && (!('email' in data) || (data.email is string && data.email.size() <= 320))
        && (!('displayName' in data) || (data.displayName is string && data.displayName.size() <= 100));
    }
    
    // Validate progress document structure
    // Structure: { notes: { [noteId]: { score: number } } }
    function isValidProgressDoc() {
      let data = request.resource.data;
      
      // Must have only 'notes' field
      return data.keys().hasOnly(['notes'])
        // Notes must be a map
        && data.notes is map
        // Limit total size to prevent abuse (max 1000 notes)
        && data.notes.size() <= 1000;
    }
  }
}