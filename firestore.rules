rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // DENY ALL BY DEFAULT
    // Any path not explicitly allowed is denied
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
    
    // ============================================
    // USER DATA RULES
    // Path: /users/{userId}
    // ============================================
    match /users/{userId} {
      // Users can only read their own user document
      allow read: if isOwner(userId);
      
      // Users can create their own user document (on first sign-up)
      allow create: if isOwner(userId) 
        && isValidUserDoc()
        && request.resource.data.size() <= 10;
      
      // Users can update their own user document
      allow update: if isOwner(userId) 
        && isValidUserDoc()
        && request.resource.data.size() <= 10;
      
      // Prevent accidental/malicious deletion of user data
      allow delete: if false;
      
      // ============================================
      // PROGRESS SUBCOLLECTION - PER SUBJECT
      // Path: /users/{userId}/progress/{subjectId}/state
      // Stores study progress per subject: { notes: { [noteId]: { score: number } } }
      // ============================================
      match /progress/{subjectId}/{docId} {
        // Users can read their own progress
        allow read: if isOwner(userId);
        
        // Users can create progress document
        allow create: if isOwner(userId) 
          && isValidProgressDoc()
          && docId == 'state'; // Only allow the 'state' document
        
        // Users can update their progress
        allow update: if isOwner(userId) 
          && isValidProgressDoc()
          && docId == 'state'; // Only allow the 'state' document
        
        // Prevent deletion of progress data
        allow delete: if false;
      }
    }
    
    // ============================================
    // ADMIN COLLECTION
    // Path: /admins/{userId}
    // ============================================
    match /admins/{adminId} {
      // Anyone authenticated can read (to check if they're admin)
      allow read: if request.auth != null;
      
      // Only existing admins can create new admins
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // SUBJECTS (Super Categories)
    // Path: /subjects/{subjectId}
    // ============================================
    match /subjects/{subjectId} {
      // All authenticated users can read subjects
      allow read: if request.auth != null;
      
      // Only admins can create, update, delete subjects
      allow create, update: if isAdmin() && isValidSubject();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // CATEGORIES
    // Path: /categories/{categoryId}
    // ============================================
    match /categories/{categoryId} {
      allow read: if request.auth != null;
      allow create, update: if isAdmin() && isValidCategory();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // SUBCATEGORIES
    // Path: /subcategories/{subcategoryId}
    // ============================================
    match /subcategories/{subcategoryId} {
      allow read: if request.auth != null;
      allow create, update: if isAdmin() && isValidSubcategory();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // SUB-SUBCATEGORIES
    // Path: /subSubcategories/{subSubcategoryId}
    // ============================================
    match /subSubcategories/{subSubcategoryId} {
      allow read: if request.auth != null;
      allow create, update: if isAdmin() && isValidSubSubcategory();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // NOTES
    // Path: /notes/{noteId}
    // ============================================
    match /notes/{noteId} {
      allow read: if request.auth != null;
      allow create, update: if isAdmin() && isValidNote();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if the authenticated user owns this resource
    function isOwner(userId) {
      return request.auth != null 
        && request.auth.uid == userId;
    }
    
    // Stricter version requiring email verification
    // Uncomment and use isOwnerVerified() instead of isOwner() to enforce
    // function isOwnerVerified(userId) {
    //   return request.auth != null 
    //     && request.auth.uid == userId
    //     && request.auth.token.email_verified == true;
    // }
    
    // Validate user document structure
    function isValidUserDoc() {
      let data = request.resource.data;
      // Only allow specific fields
      return data.keys().hasOnly(['createdAt', 'updatedAt', 'email', 'displayName'])
        // Validate field types if present
        && (!('createdAt' in data) || data.createdAt is timestamp)
        && (!('updatedAt' in data) || data.updatedAt is timestamp)
        && (!('email' in data) || (data.email is string && data.email.size() <= 320))
        && (!('displayName' in data) || (data.displayName is string && data.displayName.size() <= 100));
    }
    
    // Validate progress document structure
    // Structure: { notes: { [noteId]: { score: number } } }
    function isValidProgressDoc() {
      let data = request.resource.data;
      
      // Must have only 'notes' field
      return data.keys().hasOnly(['notes'])
        // Notes must be a map
        && data.notes is map
        // Limit total size to prevent abuse (max 1000 notes)
        && data.notes.size() <= 1000;
    }
    
    // Check if user is an admin
    function isAdmin() {
      return request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Validate subject document
    function isValidSubject() {
      let data = request.resource.data;
      return data.keys().hasOnly(['name', 'description', 'icon', 'color', 'order', 'createdAt', 'updatedAt'])
        && data.name is string && data.name.size() <= 200
        && data.order is number
        && (!('description' in data) || (data.description is string && data.description.size() <= 1000))
        && (!('icon' in data) || (data.icon is string && data.icon.size() <= 100))
        && (!('color' in data) || (data.color is string && data.color.size() <= 50));
    }
    
    // Validate category document
    function isValidCategory() {
      let data = request.resource.data;
      return data.keys().hasOnly(['subjectId', 'name', 'description', 'icon', 'order', 'createdAt', 'updatedAt'])
        && data.subjectId is string && data.subjectId.size() <= 100
        && data.name is string && data.name.size() <= 200
        && data.order is number
        && (!('description' in data) || (data.description is string && data.description.size() <= 1000))
        && (!('icon' in data) || (data.icon is string && data.icon.size() <= 100));
    }
    
    // Validate subcategory document
    function isValidSubcategory() {
      let data = request.resource.data;
      return data.keys().hasOnly(['subjectId', 'categoryId', 'name', 'description', 'order', 'createdAt', 'updatedAt'])
        && data.subjectId is string && data.subjectId.size() <= 100
        && data.categoryId is string && data.categoryId.size() <= 100
        && data.name is string && data.name.size() <= 200
        && data.order is number
        && (!('description' in data) || (data.description is string && data.description.size() <= 1000));
    }
    
    // Validate sub-subcategory document
    function isValidSubSubcategory() {
      let data = request.resource.data;
      return data.keys().hasOnly(['subjectId', 'categoryId', 'subcategoryId', 'name', 'description', 'order', 'createdAt', 'updatedAt'])
        && data.subjectId is string && data.subjectId.size() <= 100
        && data.categoryId is string && data.categoryId.size() <= 100
        && data.subcategoryId is string && data.subcategoryId.size() <= 100
        && data.name is string && data.name.size() <= 200
        && data.order is number
        && (!('description' in data) || (data.description is string && data.description.size() <= 1000));
    }
    
    // Validate note document
    function isValidNote() {
      let data = request.resource.data;
      return data.keys().hasOnly(['subjectId', 'categoryId', 'subcategoryId', 'subSubcategoryId', 'title', 'content', 'interviewAnswer', 'order', 'createdAt', 'updatedAt'])
        && data.subjectId is string && data.subjectId.size() <= 100
        && data.categoryId is string && data.categoryId.size() <= 100
        && data.title is string && data.title.size() <= 500
        && data.content is string && data.content.size() <= 100000
        && data.order is number
        && (!('subcategoryId' in data) || (data.subcategoryId is string && data.subcategoryId.size() <= 100))
        && (!('subSubcategoryId' in data) || (data.subSubcategoryId is string && data.subSubcategoryId.size() <= 100))
        && (!('interviewAnswer' in data) || (data.interviewAnswer is string && data.interviewAnswer.size() <= 5000));
    }
  }
}